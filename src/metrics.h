// Copyright (c) 2016 The Zcash developers
// Distributed under the MIT software license, see the accompanying
// file COPYING or http://www.opensource.org/licenses/mit-license.php.

#include "uint256.h"

#include <atomic>
#include <mutex>
#include <string>

struct AtomicCounter {
    std::atomic<uint64_t> value;

    AtomicCounter() : value {0} { }

    void increment(){
        ++value;
    }

    void decrement(){
        --value;
    }

    int get() const {
        return value.load();
    }
};

class AtomicTimer {
private:
    std::mutex mtx;
    uint64_t threads;
    int64_t start_time;
    int64_t total_time;

public:
    AtomicTimer() : threads(0), start_time(0), total_time(0) {}

    /**
     * Starts timing on first call, and counts the number of calls.
     */
    void start();

    /**
     * Counts number of calls, and stops timing after it has been called as
     * many times as start().
     */
    void stop();

    bool running();

    uint64_t threadCount();

    double rate(const AtomicCounter& count);
};

extern AtomicCounter transactionsValidated;
extern AtomicCounter ehSolverRuns;
extern AtomicCounter solutionTargetChecks;
extern AtomicTimer miningTimer;

void TrackMinedBlock(uint256 hash);

void MarkStartTime();
double GetLocalSolPS();
int EstimateNetHeightInner(int height, int64_t tipmediantime,
                           int heightLastCheckpoint, int64_t timeLastCheckpoint,
                           int64_t genesisTime, int64_t targetSpacing);

void TriggerRefresh();

void ConnectMetricsScreen();
void ThreadShowMetricsScreen();

/**
 * Rendering options:
 * Logo: img2txt -W 60 -H 30 -f utf8 -d none -g 0.7 ./ZenCash\ Logo\ -\ RGB_Icon\ -\ Full\ Color\ -\ Crop.png > zen.utf8
 */
const std::string METRICS_ART =
"                                         [0;37;5;40;100m8[0m                  \n"
"                                      [0;36;5;40;100mt[0;1;30;90;44m88888[0;36;5;40;100m%[0m               \n"
"                                  [0;1;30;90;47m8[0;36;5;40;100m8[0;1;30;90;44m88888888888[0;34;5;40;100mS[0;37;5;40;100m@[0m           \n"
"                               [0;36;5;40;100m;[0;1;30;90;44m8888888888888888888[0;36;5;40;100mt[0m        \n"
"                           [0;1;30;90;47m [0;36;5;40;100m8[0;1;30;90;44m8888888888888888888888888[0;36;5;40;100m8[0;37;5;40;100m8[0m    \n"
"                           [0;37;5;46;106m8@[0;1;30;90;46m88[0;1;30;90;44m888888888888888888888[0;30;44m88[0;34;40m88[0m    \n"
"                           [0;37;5;46;106m88888[0;37;46mX[0;1;30;90;46m8X[0;1;30;90;44m88888888888888[0;30;44m8[0;34;40m888888[0m    \n"
"                 [0;37;5;40;100m@[0;34;5;40;100m@[0;34;40m888[0;36;5;40;100m.[0m    [0;37;5;46;106m88888888@[0;1;30;90;46m8@[0;1;30;90;44m8888888[0;30;44m88[0;34;40m888888888[0m    \n"
"              [0;36;5;40;100m.[0;34;40m8888888888[0;36;5;40;100mS[0m   [0;1;37;97;47mX[0;1;36;96;47m8[0;37;5;46;106m88888888[0;37;46mX[0;1;30;90;46m8[0;36;5;40;100m8[0;30;44m8[0;34;40m8888888888888[0m    \n"
"          [0;37;5;40;100m8[0;34;5;40;100mX[0;34;40m8888888888888888[0;30;44m8[0;36;5;40;100m [0m   [0;1;36;96;47mX[0;37;5;46;106m8888888[0;1;30;90;46m8[0;34;40m88888888888888[0m    \n"
"       [0;36;5;40;100m [0;1;30;90;44m8[0;34;40m88888888888888888888888[0;36;5;40;100mS[0m   [0;1;36;96;47m8[0;37;5;46;106m8888[0;1;30;90;46m8[0;34;40m88888888888888[0m    \n"
"      [0;30;44m88[0;34;40m88888888888888888888888[0;30;44m8[0;1;30;90;46m88[0;37;5;46;106m@[0m [0;1;36;96;47m@[0;37;5;46;106m8888[0;1;30;90;46m8[0;34;40m88888888888888[0m    \n"
"      [0;1;30;90;44m8888[0;30;44m88[0;34;40m8888888888888888[0;36;5;40;100m8[0;1;30;90;46m8[0;37;46m@[0;37;5;46;106m8888[0m [0;1;36;96;47m@[0;37;5;46;106m8888[0;1;30;90;46m8[0;34;40m88888888888888[0m    \n"
"      [0;1;30;90;44m8888888[0;30;44m88[0;34;40m888888888[0;30;44m8[0;1;30;90;46m@8[0;37;5;46;106m@8888888[0m [0;1;36;96;47m@[0;37;5;46;106m8888[0;1;30;90;46m8[0;34;40m88888888888[0;30;44m8[0;36;5;40;100m [0m     \n"
"      [0;1;30;90;44m88888888888[0;30;44m88[0;34;40m88[0;36;5;40;100m8[0;1;30;90;46m8[0;37;46mX[0;37;5;46;106m8888888[0;1;36;96;47m8[0;1;37;97;47mX[0m   [0;1;36;96;47m@[0;37;5;46;106m8888[0;1;30;90;46m8[0;34;40m88888888[0;36;5;40;100mX[0m         \n"
"      [0;1;30;90;44m88888888888888[0;37;46mX[0;37;5;46;106m8888888[0;1;36;96;47mX[0m       [0;1;36;96;47m@[0;37;5;46;106m8888[0;1;30;90;46m8[0;34;40m88888[0;36;5;40;100m.[0m            \n"
"      [0;1;30;90;44m88888888888888[0;37;46mX[0;37;5;46;106m8888[0;1;36;96;47mX[0m   [0;1;36;96;47mS[0;37;5;46;106m8888[0;1;36;96;47m8[0;1;37;97;47m@[0m  [0;1;37;97;47m@[0;1;36;96;47m8[0;37;5;46;106m8[0;1;30;90;46m8[0;34;40m8[0;34;5;40;100m8[0;37;5;40;100m@[0m   [0;1;36;96;47m@[0;37;5;46;106m8888[0;1;36;96;47mS[0m      \n"
"      [0;1;30;90;44m88888888888888[0;37;46mX[0;37;5;46;106m8888[0m  [0;1;30;90;46m@8[0;1;36;96;47m8[0;37;5;46;106m88888888[0;1;36;96;47mS[0m     [0;1;37;97;47mS[0;37;5;46;106m88888888@[0;1;30;90;46m88[0m    \n"
"      [0;1;30;90;44m88888888888888[0;37;46mX[0;37;5;46;106m8888[0m  [0;34;40m888[0;36;5;40;100m8[0;1;30;90;46m8[0;37;46mX[0;37;5;46;106m88888888[0;1;36;96;47m8[0;37;5;46;106m88888888[0;37;46m@[0;1;30;90;46m8[0;36;5;40;100m8[0;1;30;90;44m888[0m    \n"
"      [0;36;5;40;100mt[0;1;30;90;44m8888888888888[0;37;46mX[0;37;5;46;106m8888[0m  [0;34;40m888888[0;30;44m8[0;1;30;90;46m@8[0;37;5;46;106m@888888888@[0;1;30;90;46m8@[0;34;5;40;100mS[0;1;30;90;44m888888[0m    \n"
"         [0;37;5;40;100m@[0;34;5;40;100m@[0;1;30;90;44m888888888[0;37;46mX[0;37;5;46;106m8888[0m  [0;34;40m8888888888[0;36;5;40;100m8[0;1;30;90;46m8[0;37;46m@[0;37;5;46;106m888[0;37;46m@[0;1;30;90;46m8[0;36;5;40;100m8[0;1;30;90;44m8888888888[0m    \n"
"             [0;36;5;40;100m%[0;1;30;90;44m888888[0;37;46mX[0;37;5;46;106m8888[0m  [0;34;40m8888888888888[0;1;30;90;44m8[0;1;30;90;46m@[0;36;5;40;100m8[0;1;30;90;44m8888888888888[0m    \n"
"                [0;36;5;40;100m [0;34;5;40;100m@[0;1;30;90;44m88[0;37;46mX[0;37;5;46;106m88[0;1;36;96;47m@[0m   [0;34;40m88888888888888[0;30;44m8[0;1;30;90;44m88888888888888[0m    \n"
"                    [0;1;37;97;47m;[0m      [0;34;40m88888888888888[0;30;44m8[0;1;30;90;44m88888888888888[0m    \n"
"                          [0;34;40m88888888888888[0;30;44m8[0;1;30;90;44m88888888888888[0m    \n"
"                           [0;36;5;40;100mS[0;34;40m8888888888888[0;30;44m8[0;1;30;90;44m8888888888888[0;36;5;40;100m%[0m    \n"
"                              [0;36;5;40;100m.[0;34;40m8888888888[0;30;44m8[0;1;30;90;44m8888888888[0;36;5;40;100m.[0m       \n"
"                                 [0;37;5;40;100m8[0;36;5;40;100mX[0;34;40m888888[0;30;44m8[0;1;30;90;44m888888[0;36;5;40;100m@[0;1;30;90;47m8[0m          \n"
"                                     [0;36;5;40;100m:[0;34;40m888[0;30;44m8[0;1;30;90;44m888[0;36;5;40;100m:[0m              \n"
"                                        [0;37;5;40;100m@[0;36;5;40;100mS[0;1;30;90;47m8[0m                 ";
